# Feature Pack: vault
# Password management and 2FA vault with team sharing, folders, CSV import, and TOTP

name: vault
description: Password management and 2FA vault with team sharing, folders, CSV import, and TOTP

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
# Primary pages:
# - /vault: Main Vault page (daily driver)
# - /vault/import: CSV import page
# - /vault/items/[itemId]: Item detail page
# - /vault/items/[itemId]/edit: Item edit page
routes:
  - path: /vault
    page: VaultLanding
    roles: []  # Empty = authenticated users only
  - path: /vault/import
    page: ImportCSV
    roles: []
  - path: /vault/items/[itemId]
    page: ItemDetail
    roles: []
  - path: /vault/items/[itemId]/edit
    page: ItemEdit
    roles: []

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
# Navigation items under Vault:
# - Vault: Main daily driver page
# - Import: CSV import page
nav:
  - id: vault
    label: Vault
    path: /vault
    icon: Lock
    group: main
    showWhen: authenticated
    weight: 200
    children:
      - id: vault-dashboards
        label: Dashboard
        path: /dashboards?pack=vault
        icon: LayoutDashboard
        weight: 0
        showWhen: authenticated
      - id: vault-main
        label: Vault
        path: /vault
        icon: Lock
        weight: 100
        showWhen: authenticated
      - id: vault-import
        label: Import
        path: /vault/import
        icon: Upload
        weight: 110
        showWhen: authenticated

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/vault.ts
  exports: [
    vaultVaults,
    vaultFolders,
    vaultItems,
    vaultAcls,
    vaultSmsNumbers,
    vaultSmsMessages,
    vaultWebhookLogs,
    vaultAuditEvents,
    vaultStaticGroups,
    vaultGroupMembers,
    VaultVault,
    VaultFolder,
    VaultItem,
    VaultAcl,
    VaultSmsNumber,
    VaultSmsMessage,
    VaultWebhookLog,
    VaultAuditEvent,
    VaultStaticGroup,
    VaultGroupMember,
    InsertVaultVault,
    InsertVaultFolder,
    InsertVaultItem,
    InsertVaultAcl,
    InsertVaultSmsNumber,
    InsertVaultSmsMessage,
    InsertVaultWebhookLog,
    InsertVaultAuditEvent,
    InsertVaultStaticGroup,
    InsertVaultGroupMember,
  ]

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints (handler-based pattern - RECOMMENDED)
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    # Vaults
    - path: /api/vault/vaults
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/vaults"
      description: "List vaults (GET) or create shared vault (POST)"
    - path: /api/vault/vaults/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/vaults-id"
      description: "Get, update, or delete a vault"
    # Folders
    - path: /api/vault/folders
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/folders"
      description: "List folders (GET) or create folder (POST)"
    - path: /api/vault/folders/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/folders-id"
      description: "Get, update, or delete a folder"
    - path: /api/vault/folders/[id]/move
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/folders-move"
      description: "Move folder to new parent"
    # Items
    - path: /api/vault/items
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/items"
      description: "List items (GET) or create item (POST)"
    - path: /api/vault/items/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/items-id"
      description: "Get, update, or delete an item"
    - path: /api/vault/items/[id]/reveal
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-reveal"
      description: "Reveal decrypted password/secret (audited)"
    - path: /api/vault/items/[id]/copy
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-copy"
      description: "Copy password to clipboard (audited)"
    - path: /api/vault/items/[id]/move
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-move"
      description: "Move item to new folder"
    # Sharing/ACL
    - path: /api/vault/acl
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/acl"
      description: "List ACLs (GET) or create ACL entry (POST)"
    - path: /api/vault/acl/[id]
      methods: [DELETE]
      handler: "@hit/feature-pack-vault/server/api/acl-id"
      description: "Delete ACL entry"
    - path: /api/vault/acl/recompute
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/acl-recompute"
      description: "Recompute effective ACLs for a resource"
    # 2FA TOTP
    - path: /api/vault/items/[id]/totp/import
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-totp-import"
      description: "Import TOTP secret (QR or manual)"
    - path: /api/vault/items/[id]/totp/code
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-totp-code"
      description: "Generate TOTP code (audited)"
    - path: /api/vault/items/[id]/totp
      methods: [DELETE]
      handler: "@hit/feature-pack-vault/server/api/items-totp"
      description: "Remove TOTP secret"
    # Import
    - path: /api/vault/import/csv/preview
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/import-csv-preview"
      description: "Preview CSV import with mapping"
    - path: /api/vault/import/csv/commit
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/import-csv-commit"
      description: "Commit CSV import"
    # Search
    - path: /api/vault/search
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/search"
      description: "Search items by metadata (access-controlled)"
    # Audit
    - path: /api/vault/audit
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/audit"
      description: "List audit events (filtered by access)"
    - path: /api/vault/audit/export
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/audit-export"
      description: "Export audit log (admin only)"
    # Groups (static only)
    - path: /api/vault/groups
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/groups"
      description: "List groups (GET) or create group (POST) - static groups only"
    - path: /api/vault/groups/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/groups-id"
      description: "Get, update, or delete group - static groups only"
    - path: /api/vault/groups/[id]/members
      methods: [GET, POST, DELETE]
      handler: "@hit/feature-pack-vault/server/api/groups-members"
      description: "Manage group members - static groups only"

# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
requires:
  modules: [auth]

dependencies:
  feature_packs:
    - name: dashboard-shell

# ─────────────────────────────────────────────────────────────────────────────
# CONFIGURATION OPTIONS
# ─────────────────────────────────────────────────────────────────────────────
# ─────────────────────────────────────────────────────────────────────────────
# METRICS - Feature pack metric definitions
# ─────────────────────────────────────────────────────────────────────────────
metrics:
  definitions:
    - key: fp.vault.shared_folder_count
      label: Shared Folder Count
      unit: count
      icon: Lock
      icon_color: "#10b981"
      rollup_strategy: last
      entity_kinds: [project]
      time_kind: realtime

config:
  schema:
    use_dynamic_groups:
      type: boolean
      default: false
      description: "Use dynamic groups from auth module (if auth.user_groups_enabled is true), otherwise use static groups or roles"
    encryption_key_version:
      type: integer
      default: 1
      description: "Current encryption key version for envelope encryption"
    enable_export:
      type: boolean
      default: true
      description: "Enable vault export functionality"
    require_reauth_for_reveal:
      type: boolean
      default: false
      description: "Require re-authentication before revealing sensitive items"
    # NOTE: SMS/email inbox + inbound webhooks were removed. TOTP remains the supported 2FA mechanism in Vault.

