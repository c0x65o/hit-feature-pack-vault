# Feature Pack: vault
# Password management and 2FA vault with team sharing, folders, CSV import, TOTP, and SMS inbox

name: vault
version: 1.0.0
description: Password management and 2FA vault with team sharing, folders, CSV import, TOTP, and SMS inbox

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
# Primary pages:
# - /vault: Main Vault page (daily driver)
# - /vault/import: CSV import page
# - /vault/setup: Setup page (admin only)
# - /vault/items/[itemId]: Item detail page
# - /vault/items/[itemId]/edit: Item edit page
routes:
  - path: /vault
    page: VaultLanding
    roles: []  # Empty = authenticated users only
  - path: /vault/import
    page: ImportCSV
    roles: []
  - path: /vault/setup
    page: VaultSetup
    roles: [admin]  # Admin only - configure project SMS 2FA phone number and view inbox for debugging
  - path: /vault/items/[itemId]
    page: ItemDetail
    roles: []
  - path: /vault/items/[itemId]/edit
    page: ItemEdit
    roles: []

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
# Three top-level navigation items under Vault:
# - Vault: Main daily driver page
# - Import: CSV import page
# - Setup: Admin configuration (project SMS 2FA phone number + inbox for debugging)
nav:
  - id: vault
    label: Vault
    path: /vault
    icon: Lock
    group: main
    showWhen: authenticated
    weight: 200
    children:
      - id: vault-main
        label: Vault
        path: /vault
        icon: Lock
        weight: 100
        showWhen: authenticated
      - id: vault-import
        label: Import
        path: /vault/import
        icon: Upload
        weight: 110
        showWhen: authenticated
      - id: vault-setup
        label: Setup
        path: /vault/setup
        icon: Settings
        weight: 120
        showWhen: authenticated
        roles: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/vault.ts
  exports: [
    vaultVaults,
    vaultFolders,
    vaultItems,
    vaultAcls,
    vaultSmsNumbers,
    vaultSmsMessages,
    vaultWebhookLogs,
    vaultAuditEvents,
    vaultStaticGroups,
    vaultGroupMembers,
    VaultVault,
    VaultFolder,
    VaultItem,
    VaultAcl,
    VaultSmsNumber,
    VaultSmsMessage,
    VaultWebhookLog,
    VaultAuditEvent,
    VaultStaticGroup,
    VaultGroupMember,
    InsertVaultVault,
    InsertVaultFolder,
    InsertVaultItem,
    InsertVaultAcl,
    InsertVaultSmsNumber,
    InsertVaultSmsMessage,
    InsertVaultWebhookLog,
    InsertVaultAuditEvent,
    InsertVaultStaticGroup,
    InsertVaultGroupMember,
  ]

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints (handler-based pattern - RECOMMENDED)
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    # Vaults
    - path: /api/vault/vaults
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/vaults"
      description: "List vaults (GET) or create shared vault (POST)"
    - path: /api/vault/vaults/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/vaults-id"
      description: "Get, update, or delete a vault"
    # Folders
    - path: /api/vault/folders
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/folders"
      description: "List folders (GET) or create folder (POST)"
    - path: /api/vault/folders/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/folders-id"
      description: "Get, update, or delete a folder"
    - path: /api/vault/folders/[id]/move
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/folders-move"
      description: "Move folder to new parent"
    # Items
    - path: /api/vault/items
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/items"
      description: "List items (GET) or create item (POST)"
    - path: /api/vault/items/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/items-id"
      description: "Get, update, or delete an item"
    - path: /api/vault/items/[id]/reveal
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-reveal"
      description: "Reveal decrypted password/secret (audited)"
    - path: /api/vault/items/[id]/copy
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-copy"
      description: "Copy password to clipboard (audited)"
    - path: /api/vault/items/[id]/move
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-move"
      description: "Move item to new folder"
    # Sharing/ACL
    - path: /api/vault/acl
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/acl"
      description: "List ACLs (GET) or create ACL entry (POST)"
    - path: /api/vault/acl/[id]
      methods: [DELETE]
      handler: "@hit/feature-pack-vault/server/api/acl-id"
      description: "Delete ACL entry"
    - path: /api/vault/acl/recompute
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/acl-recompute"
      description: "Recompute effective ACLs for a resource"
    # 2FA TOTP
    - path: /api/vault/items/[id]/totp/import
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-totp-import"
      description: "Import TOTP secret (QR or manual)"
    - path: /api/vault/items/[id]/totp/code
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-totp-code"
      description: "Generate TOTP code (audited)"
    - path: /api/vault/items/[id]/totp
      methods: [DELETE]
      handler: "@hit/feature-pack-vault/server/api/items-totp"
      description: "Remove TOTP secret"
    - path: /api/vault/items/[id]/sms/request
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-sms-request"
      description: "Request 2FA code via SMS (sends SMS to user's phone)"
    # SMS
    - path: /api/vault/sms/numbers
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/sms-numbers"
      description: "List SMS numbers (GET) or provision number (POST)"
    - path: /api/vault/sms/numbers/[id]
      methods: [GET, DELETE]
      handler: "@hit/feature-pack-vault/server/api/sms-numbers-id"
      description: "Get or delete SMS number"
    - path: /api/vault/sms/webhook/inbound
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/sms-webhook-inbound"
      description: "Inbound SMS webhook (Twilio/etc)"
    - path: /api/vault/sms/numbers/[id]/messages
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/sms-numbers-messages"
      description: "List messages for SMS number"
    - path: /api/vault/sms/messages/[id]/reveal
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/sms-messages-reveal"
      description: "Reveal SMS message body (audited)"
    - path: /api/vault/webhook-logs
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/webhook-logs"
      description: "List webhook logs (admin only)"
    # Import
    - path: /api/vault/import/csv/preview
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/import-csv-preview"
      description: "Preview CSV import with mapping"
    - path: /api/vault/import/csv/commit
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/import-csv-commit"
      description: "Commit CSV import"
    # Search
    - path: /api/vault/search
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/search"
      description: "Search items by metadata (access-controlled)"
    # Audit
    - path: /api/vault/audit
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/audit"
      description: "List audit events (filtered by access)"
    - path: /api/vault/audit/export
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/audit-export"
      description: "Export audit log (admin only)"
    # Groups (static only)
    - path: /api/vault/groups
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/groups"
      description: "List groups (GET) or create group (POST) - static groups only"
    - path: /api/vault/groups/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/groups-id"
      description: "Get, update, or delete group - static groups only"
    - path: /api/vault/groups/[id]/members
      methods: [GET, POST, DELETE]
      handler: "@hit/feature-pack-vault/server/api/groups-members"
      description: "Manage group members - static groups only"

# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
requires:
  modules: [auth]

dependencies:
  feature_packs:
    - name: dashboard-shell

# ─────────────────────────────────────────────────────────────────────────────
# CONFIGURATION OPTIONS
# ─────────────────────────────────────────────────────────────────────────────
config:
  schema:
    use_dynamic_groups:
      type: boolean
      default: false
      description: "Use dynamic groups from auth module (if auth.user_groups_enabled is true), otherwise use static groups or roles"
    sms_provider:
      type: string
      default: "fdroid"
      description: "SMS provider: 'twilio' for Twilio integration, 'fdroid' for F-Droid Android phone relay, or 'custom'"
    sms_retention_days:
      type: integer
      default: 30
      description: "SMS message retention period in days"
    encryption_key_version:
      type: integer
      default: 1
      description: "Current encryption key version for envelope encryption"
    enable_export:
      type: boolean
      default: true
      description: "Enable vault export functionality"
    require_reauth_for_reveal:
      type: boolean
      default: false
      description: "Require re-authentication before revealing sensitive items"
    sms_2fa_enabled:
      type: boolean
      default: true
      description: "Enable SMS 2FA functionality (requires Twilio configuration)"

