# Feature Pack: vault
# Password management and 2FA vault with team sharing, folders, CSV import, TOTP, and SMS inbox

name: vault
version: 1.0.0
description: Password management and 2FA vault with team sharing, folders, CSV import, TOTP, and SMS inbox

# Route definitions - mapped to React components
routes:
  - path: /vault
    page: VaultLanding
    roles: []  # Empty = authenticated users only
  - path: /vault/personal
    page: PersonalVault
    roles: []
  - path: /vault/shared
    page: SharedVaults
    roles: []
  - path: /vault/shared/[vaultId]
    page: SharedVaultDetail
    roles: []
  - path: /vault/shared/[vaultId]/folders/[folderId]
    page: FolderView
    roles: []
  - path: /vault/items/[id]
    page: ItemDetail
    roles: []
  - path: /vault/items/[id]/edit
    page: ItemEdit
    roles: []
  - path: /vault/import
    page: ImportCSV
    roles: []
  - path: /vault/admin/groups
    page: GroupManagement
    roles: [admin]  # Only if static groups enabled

# Navigation contributions - auto-added to shell sidebar
nav:
  - id: vault
    label: Vault
    path: /vault
    icon: Lock
    group: main
    showWhen: authenticated
    weight: 200
    children:
      - id: vault-personal
        label: Personal
        path: /vault/personal
        icon: User
        weight: 100
        showWhen: authenticated
      - id: vault-shared
        label: Shared
        path: /vault/shared
        icon: Users
        weight: 110
        showWhen: authenticated
      - id: vault-import
        label: Import
        path: /vault/import
        icon: Upload
        weight: 120
        showWhen: authenticated

# Schema contributions (Drizzle tables)
# Projects import these into their schema
schema:
  source: src/schema/vault.ts
  exports: [
    vaultVaults,
    vaultFolders,
    vaultItems,
    vaultAcls,
    vaultSmsNumbers,
    vaultSmsMessages,
    vaultAuditEvents,
    vaultStaticGroups,
    vaultGroupMembers,
    VaultVault,
    VaultFolder,
    VaultItem,
    VaultAcl,
    VaultSmsNumber,
    VaultSmsMessage,
    VaultAuditEvent,
    VaultStaticGroup,
    VaultGroupMember,
    InsertVaultVault,
    InsertVaultFolder,
    InsertVaultItem,
    InsertVaultAcl,
    InsertVaultSmsNumber,
    InsertVaultSmsMessage,
    InsertVaultAuditEvent,
    InsertVaultStaticGroup,
    InsertVaultGroupMember,
  ]

# API routes the feature pack expects
# Applications should create these routes using the schema
api:
  routes:
    # Vaults
    - path: /api/vault/vaults
      methods: [GET, POST]
      description: "List vaults (GET) or create shared vault (POST)"
    - path: /api/vault/vaults/[id]
      methods: [GET, PUT, DELETE]
      description: "Get, update, or delete a vault"
    # Folders
    - path: /api/vault/folders
      methods: [GET, POST]
      description: "List folders (GET) or create folder (POST)"
    - path: /api/vault/folders/[id]
      methods: [GET, PUT, DELETE]
      description: "Get, update, or delete a folder"
    - path: /api/vault/folders/[id]/move
      methods: [POST]
      description: "Move folder to new parent"
    # Items
    - path: /api/vault/items
      methods: [GET, POST]
      description: "List items (GET) or create item (POST)"
    - path: /api/vault/items/[id]
      methods: [GET, PUT, DELETE]
      description: "Get, update, or delete an item"
    - path: /api/vault/items/[id]/reveal
      methods: [POST]
      description: "Reveal decrypted password/secret (audited)"
    - path: /api/vault/items/[id]/copy
      methods: [POST]
      description: "Copy password to clipboard (audited)"
    - path: /api/vault/items/[id]/move
      methods: [POST]
      description: "Move item to new folder"
    # Sharing/ACL
    - path: /api/vault/acl
      methods: [GET, POST]
      description: "List ACLs (GET) or create ACL entry (POST)"
    - path: /api/vault/acl/[id]
      methods: [DELETE]
      description: "Delete ACL entry"
    - path: /api/vault/acl/recompute
      methods: [POST]
      description: "Recompute effective ACLs for a resource"
    # 2FA TOTP
    - path: /api/vault/items/[id]/totp/import
      methods: [POST]
      description: "Import TOTP secret (QR or manual)"
    - path: /api/vault/items/[id]/totp/code
      methods: [POST]
      description: "Generate TOTP code (audited)"
    - path: /api/vault/items/[id]/totp
      methods: [DELETE]
      description: "Remove TOTP secret"
    # SMS
    - path: /api/vault/sms/numbers
      methods: [GET, POST]
      description: "List SMS numbers (GET) or provision number (POST)"
    - path: /api/vault/sms/numbers/[id]
      methods: [GET, DELETE]
      description: "Get or delete SMS number"
    - path: /api/vault/sms/webhook/inbound
      methods: [POST]
      description: "Inbound SMS webhook (Twilio/etc)"
    - path: /api/vault/sms/numbers/[id]/messages
      methods: [GET]
      description: "List messages for SMS number"
    - path: /api/vault/sms/messages/[id]/reveal
      methods: [POST]
      description: "Reveal SMS message body (audited)"
    # Import
    - path: /api/vault/import/csv/preview
      methods: [POST]
      description: "Preview CSV import with mapping"
    - path: /api/vault/import/csv/commit
      methods: [POST]
      description: "Commit CSV import"
    # Search
    - path: /api/vault/search
      methods: [GET]
      description: "Search items by metadata (access-controlled)"
    # Audit
    - path: /api/vault/audit
      methods: [GET]
      description: "List audit events (filtered by access)"
    - path: /api/vault/audit/export
      methods: [GET]
      description: "Export audit log (admin only)"
    # Groups (static only)
    - path: /api/vault/groups
      methods: [GET, POST]
      description: "List groups (GET) or create group (POST) - static groups only"
    - path: /api/vault/groups/[id]
      methods: [GET, PUT, DELETE]
      description: "Get, update, or delete group - static groups only"
    - path: /api/vault/groups/[id]/members
      methods: [GET, POST, DELETE]
      description: "Manage group members - static groups only"

# Dependencies
requires:
  modules: [auth]

# Dependencies on other feature packs
dependencies:
  feature_packs:
    - name: dashboard-shell

# Configurable options
config:
  schema:
    use_dynamic_groups:
      type: boolean
      default: false
      description: "Use dynamic groups from auth module (if auth.user_groups_enabled is true), otherwise use static groups or roles"
    sms_provider:
      type: string
      default: "twilio"
      description: "SMS provider (twilio, etc.)"
    sms_retention_days:
      type: integer
      default: 30
      description: "SMS message retention period in days"
    encryption_key_version:
      type: integer
      default: 1
      description: "Current encryption key version for envelope encryption"
    enable_export:
      type: boolean
      default: true
      description: "Enable vault export functionality"
    require_reauth_for_reveal:
      type: boolean
      default: false
      description: "Require re-authentication before revealing sensitive items"

