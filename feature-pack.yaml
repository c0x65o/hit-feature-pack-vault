# Feature Pack: vault
# Password management and 2FA vault with team sharing, folders, CSV import, TOTP, and SMS inbox

name: vault
title: Vault
description: Password management and 2FA vault with team sharing, folders, CSV import, TOTP, and SMS inbox

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
# Primary pages:
# - /vault: Main Vault page (daily driver)
# - /vault/import: CSV import page
# - /vault/setup: Setup page (admin only)
# - /vault/items/[itemId]: Item detail page
# - /vault/items/[itemId]/edit: Item edit page
routes:
  - path: /vault
    page: VaultLanding
    roles: []  # Empty = authenticated users only
    authz: { entity: vaults, verb: read }
  - path: /vault/import
    page: ImportCSV
    roles: []
    authz: { entity: items, verb: write, require_create: true }
  - path: /vault/setup
    page: VaultSetup
    roles: [admin]  # Admin only - configure project SMS 2FA phone number and view inbox for debugging
    default_roles_allow: [admin]
  - path: /vault/items/[itemId]
    page: ItemDetail
    roles: []
    authz: { entity: items, verb: read }
  - path: /vault/items/[itemId]/edit
    page: ItemEdit
    roles: []
    authz: { entity: items, verb: write }

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
# Three top-level navigation items under Vault:
# - Vault: Main daily driver page
# - Import: CSV import page
# - Setup: Admin configuration (project SMS 2FA phone number + inbox for debugging)
nav:
  - id: vault
    label: Vault
    path: /vault
    icon: Lock
    group: main
    showWhen: authenticated
    weight: 200
    children:
      - id: vault-dashboards
        label: Dashboard
        path: /dashboards?pack=vault
        icon: LayoutDashboard
        weight: 0
        showWhen: authenticated
      - id: vault-main
        label: Vault
        path: /vault
        icon: Lock
        weight: 100
        showWhen: authenticated
      - id: vault-import
        label: Import
        path: /vault/import
        icon: Upload
        weight: 110
        showWhen: authenticated
      - id: vault-setup
        label: Setup
        path: /vault/setup
        icon: Settings
        weight: 120
        showWhen: authenticated
        roles: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/vault.ts
  exports: [
    vaultVaults,
    vaultFolders,
    vaultItems,
    vaultAcls,
    vaultSmsNumbers,
    vaultSmsMessages,
    vaultWebhookLogs,
    vaultAuditEvents,
    vaultStaticGroups,
    vaultGroupMembers,
    VaultVault,
    VaultFolder,
    VaultItem,
    VaultAcl,
    VaultSmsNumber,
    VaultSmsMessage,
    VaultWebhookLog,
    VaultAuditEvent,
    VaultStaticGroup,
    VaultGroupMember,
    InsertVaultVault,
    InsertVaultFolder,
    InsertVaultItem,
    InsertVaultAcl,
    InsertVaultSmsNumber,
    InsertVaultSmsMessage,
    InsertVaultWebhookLog,
    InsertVaultAuditEvent,
    InsertVaultStaticGroup,
    InsertVaultGroupMember,
  ]

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints (handler-based pattern - RECOMMENDED)
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    # Vaults
    - path: /api/vault/vaults
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/vaults"
      description: "List vaults (GET) or create shared vault (POST)"
    - path: /api/vault/vaults/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/vaults-id"
      description: "Get, update, or delete a vault"
    # Folders
    - path: /api/vault/folders
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/folders"
      description: "List folders (GET) or create folder (POST)"
    - path: /api/vault/folders/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/folders-id"
      description: "Get, update, or delete a folder"
    - path: /api/vault/folders/[id]/move
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/folders-move"
      description: "Move folder to new parent"
    # Items
    - path: /api/vault/items
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/items"
      description: "List items (GET) or create item (POST)"
    - path: /api/vault/items/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/items-id"
      description: "Get, update, or delete an item"
    - path: /api/vault/items/[id]/reveal
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-reveal"
      description: "Reveal decrypted password/secret (audited)"
    - path: /api/vault/items/[id]/copy
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-copy"
      description: "Copy password to clipboard (audited)"
    - path: /api/vault/items/[id]/move
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-move"
      description: "Move item to new folder"
    # Sharing/ACL
    - path: /api/vault/acl
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/acl"
      description: "List ACLs (GET) or create ACL entry (POST)"
    - path: /api/vault/acl/[id]
      methods: [DELETE]
      handler: "@hit/feature-pack-vault/server/api/acl-id"
      description: "Delete ACL entry"
    - path: /api/vault/acl/recompute
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/acl-recompute"
      description: "Recompute effective ACLs for a resource"
    # 2FA TOTP
    - path: /api/vault/items/[id]/totp/import
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-totp-import"
      description: "Import TOTP secret (QR or manual)"
    - path: /api/vault/items/[id]/totp/code
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-totp-code"
      description: "Generate TOTP code (audited)"
    - path: /api/vault/items/[id]/totp
      methods: [DELETE]
      handler: "@hit/feature-pack-vault/server/api/items-totp"
      description: "Remove TOTP secret"
    - path: /api/vault/items/[id]/sms/request
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/items-sms-request"
      description: "Request 2FA code via SMS (sends SMS to user's phone)"
    # SMS
    - path: /api/vault/sms/numbers
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/sms-numbers"
      description: "List SMS numbers (GET) or provision number (POST)"
    - path: /api/vault/sms/numbers/[id]
      methods: [GET, DELETE]
      handler: "@hit/feature-pack-vault/server/api/sms-numbers-id"
      description: "Get or delete SMS number"
    - path: /api/vault/sms/webhook/inbound
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/sms-webhook-inbound"
      description: "Inbound SMS webhook (F-Droid/Twilio/Custom)"
    - path: /api/vault/email/webhook/inbound
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/email-webhook-inbound"
      description: "Inbound Email webhook (Power Automate/Custom)"
    - path: /api/vault/sms/global
      methods: [GET, POST, DELETE]
      handler: "@hit/feature-pack-vault/server/api/sms-global"
      description: "Get, set, or delete global 2FA phone number (admin only for writes)"
    - path: /api/vault/email/global
      methods: [GET, POST, DELETE]
      handler: "@hit/feature-pack-vault/server/api/email-global"
      description: "Get, set, or delete global 2FA email address (admin only)"
    - path: /api/vault/email/messages/latest
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/email-messages-latest"
      description: "Get latest email messages that user has access to via item permissions"
    - path: /api/vault/sms/messages/latest
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/sms-messages-latest"
      description: "Get latest SMS messages (global inbox) for OTP detection"
    - path: /api/vault/sms/numbers/[id]/messages
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/sms-numbers-messages"
      description: "List messages for SMS number"
    - path: /api/vault/sms/messages/[id]/reveal
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/sms-messages-reveal"
      description: "Reveal SMS message body (audited)"
    - path: /api/vault/webhook-logs
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/webhook-logs"
      description: "List webhook logs (admin only)"
    - path: /api/vault/webhook/api-key
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/webhook-api-key"
      description: "Get or generate webhook API key (GUID)"
    # Import
    - path: /api/vault/import/csv/preview
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/import-csv-preview"
      description: "Preview CSV import with mapping"
    - path: /api/vault/import/csv/commit
      methods: [POST]
      handler: "@hit/feature-pack-vault/server/api/import-csv-commit"
      description: "Commit CSV import"
    # Search
    - path: /api/vault/search
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/search"
      description: "Search items by metadata (access-controlled)"
    # Audit
    - path: /api/vault/audit
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/audit"
      description: "List audit events (filtered by access)"
    - path: /api/vault/audit/export
      methods: [GET]
      handler: "@hit/feature-pack-vault/server/api/audit-export"
      description: "Export audit log (admin only)"
    # Groups (static only)
    - path: /api/vault/groups
      methods: [GET, POST]
      handler: "@hit/feature-pack-vault/server/api/groups"
      description: "List groups (GET) or create group (POST) - static groups only"
    - path: /api/vault/groups/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-vault/server/api/groups-id"
      description: "Get, update, or delete group - static groups only"
    - path: /api/vault/groups/[id]/members
      methods: [GET, POST, DELETE]
      handler: "@hit/feature-pack-vault/server/api/groups-members"
      description: "Manage group members - static groups only"

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Entity+Verb permissions model
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    # Scope Policy Tree: Vault (global) -> entity overrides.
    #
    # Scope modes:
    # - none: deny all access for this verb/entity (hide pages + block APIs)
    # - all: ignore scope (read everything)
    # - own: only owned records (personal vaults owned by user, or items/folders in personal vaults)
    # - ldd: same as own (vault entities don't have LDD fields, but personal vault ownership is checked)
    #
    # These are mutually exclusive per node; the Security Groups UI renders them as dropdowns.
    - key: vault.read.scope.none
      label: "Vault Read Scope = None"
      description: "Deny all vault read access."
      default_enabled: false
    - key: vault.read.scope.all
      label: "Vault Read Scope = All"
      description: "Read all vault entities regardless of ownership."
      default_enabled: false
    - key: vault.read.scope.own
      label: "Vault Read Scope = Own"
      description: "Read only vault entities you own (personal vaults or items/folders in personal vaults)."
      default_enabled: false
    - key: vault.read.scope.ldd
      label: "Vault Read Scope = LDD"
      description: "Read vault entities (same as own, since vault entities don't have LDD fields)."
      default_enabled: false

    - key: vault.write.scope.none
      label: "Vault Write Scope = None"
      description: "Deny all vault write access."
      default_enabled: false
    - key: vault.write.scope.all
      label: "Vault Write Scope = All"
      description: "Edit vault entities regardless of ownership."
      default_enabled: false
    - key: vault.write.scope.own
      label: "Vault Write Scope = Own"
      description: "Edit only vault entities you own (personal vaults or items/folders in personal vaults)."
      default_enabled: false
    - key: vault.write.scope.ldd
      label: "Vault Write Scope = LDD"
      description: "Edit vault entities (same as own, since vault entities don't have LDD fields)."
      default_enabled: false

    - key: vault.delete.scope.none
      label: "Vault Delete Scope = None"
      description: "Deny all vault delete access."
      default_enabled: false
    - key: vault.delete.scope.all
      label: "Vault Delete Scope = All"
      description: "Delete vault entities regardless of ownership."
      default_enabled: false
    - key: vault.delete.scope.own
      label: "Vault Delete Scope = Own"
      description: "Delete only vault entities you own (personal vaults or items/folders in personal vaults)."
      default_enabled: false
    - key: vault.delete.scope.ldd
      label: "Vault Delete Scope = LDD"
      description: "Delete vault entities (same as own, since vault entities don't have LDD fields)."
      default_enabled: false

    # Vaults entity override
    - key: vault.vaults.read.scope.none
      label: "Vault Vaults Read Scope = None"
      description: "Deny all vault read access."
      default_enabled: false
    - key: vault.vaults.read.scope.all
      label: "Vault Vaults Read Scope = All"
      description: "Read all vaults regardless of ownership."
      default_enabled: false
    - key: vault.vaults.read.scope.own
      label: "Vault Vaults Read Scope = Own"
      description: "Read only personal vaults you own."
      default_enabled: false
    - key: vault.vaults.read.scope.ldd
      label: "Vault Vaults Read Scope = LDD"
      description: "Read vaults (same as own, since vaults don't have LDD fields)."
      default_enabled: false

    - key: vault.vaults.write.scope.none
      label: "Vault Vaults Write Scope = None"
      description: "Deny all vault write access."
      default_enabled: false
    - key: vault.vaults.write.scope.all
      label: "Vault Vaults Write Scope = All"
      description: "Edit vaults regardless of ownership."
      default_enabled: false
    - key: vault.vaults.write.scope.own
      label: "Vault Vaults Write Scope = Own"
      description: "Edit only personal vaults you own."
      default_enabled: false
    - key: vault.vaults.write.scope.ldd
      label: "Vault Vaults Write Scope = LDD"
      description: "Edit vaults (same as own, since vaults don't have LDD fields)."
      default_enabled: false

    - key: vault.vaults.delete.scope.none
      label: "Vault Vaults Delete Scope = None"
      description: "Deny all vault delete access."
      default_enabled: false
    - key: vault.vaults.delete.scope.all
      label: "Vault Vaults Delete Scope = All"
      description: "Delete vaults regardless of ownership."
      default_enabled: false
    - key: vault.vaults.delete.scope.own
      label: "Vault Vaults Delete Scope = Own"
      description: "Delete only personal vaults you own."
      default_enabled: false
    - key: vault.vaults.delete.scope.ldd
      label: "Vault Vaults Delete Scope = LDD"
      description: "Delete vaults (same as own, since vaults don't have LDD fields)."
      default_enabled: false

    - key: vault.vaults.create
      label: Create Vault
      description: "Create a new vault (personal or shared)."
      default_enabled: true

    # Folders entity override
    - key: vault.folders.read.scope.none
      label: "Vault Folders Read Scope = None"
      description: "Deny all folder read access."
      default_enabled: false
    - key: vault.folders.read.scope.all
      label: "Vault Folders Read Scope = All"
      description: "Read all folders regardless of ownership."
      default_enabled: false
    - key: vault.folders.read.scope.own
      label: "Vault Folders Read Scope = Own"
      description: "Read only folders in personal vaults you own."
      default_enabled: false
    - key: vault.folders.read.scope.ldd
      label: "Vault Folders Read Scope = LDD"
      description: "Read folders (same as own, since folders don't have LDD fields)."
      default_enabled: false

    - key: vault.folders.write.scope.none
      label: "Vault Folders Write Scope = None"
      description: "Deny all folder write access."
      default_enabled: false
    - key: vault.folders.write.scope.all
      label: "Vault Folders Write Scope = All"
      description: "Edit folders regardless of ownership."
      default_enabled: false
    - key: vault.folders.write.scope.own
      label: "Vault Folders Write Scope = Own"
      description: "Edit only folders in personal vaults you own."
      default_enabled: false
    - key: vault.folders.write.scope.ldd
      label: "Vault Folders Write Scope = LDD"
      description: "Edit folders (same as own, since folders don't have LDD fields)."
      default_enabled: false

    - key: vault.folders.delete.scope.none
      label: "Vault Folders Delete Scope = None"
      description: "Deny all folder delete access."
      default_enabled: false
    - key: vault.folders.delete.scope.all
      label: "Vault Folders Delete Scope = All"
      description: "Delete folders regardless of ownership."
      default_enabled: false
    - key: vault.folders.delete.scope.own
      label: "Vault Folders Delete Scope = Own"
      description: "Delete only folders in personal vaults you own."
      default_enabled: false
    - key: vault.folders.delete.scope.ldd
      label: "Vault Folders Delete Scope = LDD"
      description: "Delete folders (same as own, since folders don't have LDD fields)."
      default_enabled: false

    - key: vault.folders.create
      label: Create Folder
      description: "Create a new folder in a vault."
      default_enabled: true

    # Items entity override
    - key: vault.items.read.scope.none
      label: "Vault Items Read Scope = None"
      description: "Deny all item read access."
      default_enabled: false
    - key: vault.items.read.scope.all
      label: "Vault Items Read Scope = All"
      description: "Read all items regardless of ownership."
      default_enabled: false
    - key: vault.items.read.scope.own
      label: "Vault Items Read Scope = Own"
      description: "Read only items in personal vaults you own."
      default_enabled: false
    - key: vault.items.read.scope.ldd
      label: "Vault Items Read Scope = LDD"
      description: "Read items (same as own, since items don't have LDD fields)."
      default_enabled: false

    - key: vault.items.write.scope.none
      label: "Vault Items Write Scope = None"
      description: "Deny all item write access."
      default_enabled: false
    - key: vault.items.write.scope.all
      label: "Vault Items Write Scope = All"
      description: "Edit items regardless of ownership."
      default_enabled: false
    - key: vault.items.write.scope.own
      label: "Vault Items Write Scope = Own"
      description: "Edit only items in personal vaults you own."
      default_enabled: false
    - key: vault.items.write.scope.ldd
      label: "Vault Items Write Scope = LDD"
      description: "Edit items (same as own, since items don't have LDD fields)."
      default_enabled: false

    - key: vault.items.delete.scope.none
      label: "Vault Items Delete Scope = None"
      description: "Deny all item delete access."
      default_enabled: false
    - key: vault.items.delete.scope.all
      label: "Vault Items Delete Scope = All"
      description: "Delete items regardless of ownership."
      default_enabled: false
    - key: vault.items.delete.scope.own
      label: "Vault Items Delete Scope = Own"
      description: "Delete only items in personal vaults you own."
      default_enabled: false
    - key: vault.items.delete.scope.ldd
      label: "Vault Items Delete Scope = LDD"
      description: "Delete items (same as own, since items don't have LDD fields)."
      default_enabled: false

    - key: vault.items.create
      label: Create Item
      description: "Create a new item in a vault."
      default_enabled: true

# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
requires:
  modules: [auth]

dependencies:
  feature_packs:
    - name: erp-shell-core

# ─────────────────────────────────────────────────────────────────────────────
# CONFIGURATION OPTIONS
# ─────────────────────────────────────────────────────────────────────────────
# ─────────────────────────────────────────────────────────────────────────────
# METRICS - Feature pack metric definitions
# ─────────────────────────────────────────────────────────────────────────────
metrics:
  definitions:
    - key: fp.vault.shared_folder_count
      label: Shared Folder Count
      unit: count
      icon: Lock
      icon_color: "#10b981"
      rollup_strategy: last
      entity_kinds: [project]
      time_kind: realtime
      # Default: On for admin templates, Off for user templates.
      default_roles_allow: [admin]

config:
  schema:
    use_dynamic_groups:
      type: boolean
      default: false
      description: "Use dynamic groups from auth module (if auth.user_groups_enabled is true), otherwise use static groups or roles"
    sms_provider:
      type: string
      default: "fdroid"
      description: "SMS provider: 'twilio' for Twilio integration, 'fdroid' for F-Droid Android phone relay, or 'custom'"
    sms_retention_days:
      type: integer
      default: 30
      description: "SMS message retention period in days"
    encryption_key_version:
      type: integer
      default: 1
      description: "Current encryption key version for envelope encryption"
    enable_export:
      type: boolean
      default: true
      description: "Enable vault export functionality"
    require_reauth_for_reveal:
      type: boolean
      default: false
      description: "Require re-authentication before revealing sensitive items"
    sms_2fa_enabled:
      type: boolean
      default: true
      description: "Enable SMS 2FA functionality (requires Twilio configuration)"
    realtime_otp_enabled:
      type: boolean
      default: true
      description: "Publish real-time OTP notifications via HIT Events (WebSocket) when inbound SMS/email messages are stored"
    realtime_otp_event_type:
      type: string
      default: "vault.otp_received"
      description: "Event type to publish/subscribe to for OTP notifications (clients subscribe; server publishes)"

